<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Migrate schema and data - dev-note</title>
        <!-- Custom HTML head -->
<!-- Book generated using mdBook -->
<meta charset="UTF-8">
<title>Intro - dev-note</title>

<!-- Custom HTML head -->

<meta name="description" content="Keep Knowledge Updating.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="rgba(0, 0, 0, 0)">

<link rel="icon" href="favicon.svg">
<link rel="shortcut icon" href="favicon.png">

<!-- Social: Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Aaron technical sharing">
<meta name="twitter:description" content="Keep Knowledge Updating">
<meta name="twitter:image" content="img/thumb.jpg">

<!-- Social: Facebook / Open Graph -->
<meta property="og:url" content="/">
<meta property="og:title" content="Aaron technical sharing">
<meta property="og:image" content="img/thumb.jpg">
<meta property="og:description" content="Keep Knowledge Updating">
<meta property="og:site_name" content="Aaron technical sharing">


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LGBM1Y6TB1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LGBM1Y6TB1');
</script>        <meta name="description" content="Keep Knowledge Updating">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item "><a href="../share.html"><strong aria-hidden="true">2.</strong> Share</a></li><li class="chapter-item "><a href="../commons.html"><strong aria-hidden="true">3.</strong> Commons</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../helper/vnstuff.html"><strong aria-hidden="true">3.1.</strong> VN helpers</a></li></ol></li><li class="chapter-item "><a href="../cicd.html"><strong aria-hidden="true">4.</strong> CI/CD</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../cicd/githubaction.html"><strong aria-hidden="true">4.1.</strong> Github-Action</a></li><li class="chapter-item "><a href="../cicd/act.html"><strong aria-hidden="true">4.2.</strong> Act</a></li><li class="chapter-item "><a href="../cicd/jenkins.html"><strong aria-hidden="true">4.3.</strong> Jenkins</a></li><li class="chapter-item "><a href="../cicd/gitlabrunner.html"><strong aria-hidden="true">4.4.</strong> Gitlab-Ci</a></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">5.</strong> Devops</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../devops/lxd.html"><strong aria-hidden="true">5.1.</strong> LXD</a></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">6.</strong> K8s</div></li><li class="chapter-item "><a href="../rust.html"><strong aria-hidden="true">7.</strong> Rust</a></li><li class="chapter-item "><a href="../python.html"><strong aria-hidden="true">8.</strong> Python</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../python/timedelta.html"><strong aria-hidden="true">8.1.</strong> Year leap</a></li></ol></li><li class="chapter-item expanded "><a href="../django.html"><strong aria-hidden="true">9.</strong> Django</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../django/select_prefetch.html"><strong aria-hidden="true">9.1.</strong> Select and Prefetch to related</a></li><li class="chapter-item expanded "><a href="../django/migrate_datatypes.html" class="active"><strong aria-hidden="true">9.2.</strong> Migrate schema and data</a></li></ol></li><li class="chapter-item "><a href="../celery.html"><strong aria-hidden="true">10.</strong> Celery</a></li><li class="chapter-item "><a href="../snippet.html"><strong aria-hidden="true">11.</strong> Snippet</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../snippet/new_django_proj.html"><strong aria-hidden="true">11.1.</strong> New Django Template</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dev-note</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="1-same-kind"><a class="header" href="#1-same-kind">1. SAME KIND.</a></h2>
<p>Base models</p>
<pre><code class="language-python"># /product/models.py
from django.db import models


class Product(models.Model):
	name = models.CharField(max_length=255)


class Variant(models.Model):
	name = models.CharField(max_length=255)
	product = models.ForeignKey(Product, on_delete=models.CASCADE)
	price = models.PositiveIntegerField()

</code></pre>
<p>i got my app name is <code>product</code> and register in <code>INSTALLED_APPS</code> settings</p>
<p><code>price = models.PositiveIntegerField()</code> need to be decimal<br />
there are db schema having some primitive type: char, int, varchar... another.<br />
But for all it's just number and text.<br />
Just simply to change the type to <code>DecimalField</code></p>
<pre><code class="language-python">class Variant(models.Model):
	name = models.CharField(max_length=255)
	product = models.ForeignKey(Product, on_delete=models.CASCADE)
	price = models.DecimalField(decimal_places=3, max_digits=999)
</code></pre>
<p>and then run make migration</p>
<pre><code class="language-shell">python manage.py makemigrations product
</code></pre>
<pre><code class="language-python"># /product/migrations/0002_alter_variant_price.py
# Generated by Django 4.1.7 on 2023-02-23 22:35

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        (&quot;product&quot;, &quot;0001_initial&quot;),
    ]

    operations = [
        migrations.AlterField(
            model_name=&quot;variant&quot;,
            name=&quot;price&quot;,
            field=models.DecimalField(decimal_places=3, max_digits=999),
        ),
    ]
</code></pre>
<p>Django will automate generate a new migration file base on our behavior as you can see above.<br />
And then migrate it's </p>
<pre><code class="language-shell">python manage.py migrate product
</code></pre>
<p>Now just find where we implemented this field and do more change logic, syntax, etc...<br />
Everything will work.</p>
<h5 id="well-its-just-a-simple-case-because-it-is-the-same-type-in-general-number"><a class="header" href="#well-its-just-a-simple-case-because-it-is-the-same-type-in-general-number">Well it's just a simple case, because it is the same type in general: <code>NUMBER</code></a></h5>
<h2 id="2-new-field-based-on-existed-field"><a class="header" href="#2-new-field-based-on-existed-field">2. NEW FIELD BASED ON EXISTED FIELD.</a></h2>
<p>Now we do harder from <code>int</code> to <code>datetime</code><br />
I have a subscribes app like product above too.</p>
<pre><code class="language-python"># subscribe/models.py
class Subscriber(models.Model):
	email = models.EmailField()
	age = models.SmallIntegerField()
</code></pre>
<p>This model run so long ago and have a thousand records in it<br />
For more logical and painful of code it's should be date of birth(DOB)<br />
I have to migrate existed data to new type right?</p>
<pre><code class="language-python">class Subscriber(models.Model):
	email = models.EmailField()
	age = models.SmallIntegerField()
	dob = models.DateField()
</code></pre>
<p>Well just add a dob field and run make &amp; migrate.</p>
<pre><code class="language-shell">python manage.py makemigrations
It is impossible to add a non-nullable field 'dob' to subscriber without specifying a default. This is because the database needs something to populate existing rows.
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
 2) Quit and manually define a default value in models.py.
Select an option: 
</code></pre>
<p>Ahhhh that it.<br />
If i place <code>null=True</code> to attribute in the model's field that's will work perfectly within null value. But for what?</p>
<p>So now we have to do more calculate for it.<br />
Make a fresh migrate app from django template.</p>
<pre><code class="language-shell">python manage.py makemigrations subscribe --name convert_age_dob --empty
</code></pre>
<p>and the output</p>
<pre><code class="language-shell">Migrations for 'subscribe':
  subscribe/migrations/0002_convert_age_dob.py
</code></pre>
<pre><code class="language-python"># subscribe/migrations/0002_convert_age_dob.py
# Generated by Django 4.1.7 on 2023-02-23 23:09

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        (&quot;subscribe&quot;, &quot;0001_initial&quot;),
    ]

    operations = []
</code></pre>
<p>Here the battlefield<br />
Need a function convert from age to DOB right ?</p>
<pre><code class="language-python">from django.utils import timezone

def age_to_dob(apps, schema_editor):
    Subscriber = apps.get_model('subscribe', 'Subscriber')
    today = timezone.now()
    for sub in Subscriber.objects.all():
        sub.dob = today.replace(year=today.year-sub.age)  # that too dirty but i'll fix it later
        sub.save()
</code></pre>
<p>and let operation run it</p>
<pre><code class="language-python">operations = [
        migrations.RunPython(age_to_dob, migrations.RunPython.noop),
]
</code></pre>
<p><code>migrations.RunPython.noop</code> is the step backward if we revert the migration. so for do nothing i added <code>noop</code></p>
<h6 id="now-my-completed-migration-file-is"><a class="header" href="#now-my-completed-migration-file-is">Now my completed migration file is:</a></h6>
<pre><code class="language-python"># Generated by Django 4.1.7 on 2023-02-23 23:09

from django.db import migrations, models
from django.utils import timezone


def age_to_dob(apps, schema_editor):
    Subscriber = apps.get_model('subscribe', 'Subscriber')
    today = timezone.now()
    for sub in Subscriber.objects.all():
        sub.dob = today.replace(year=today.year-sub.age)  # that too dirty but i'll fix it later
        sub.save()


class Migration(migrations.Migration):

    dependencies = [
        (&quot;subscribe&quot;, &quot;0001_initial&quot;),
    ]

    operations = [
        migrations.AddField(
            model_name='Subscriber',
            name='dob',
            field=models.DateField(null=True, default=None),
            preserve_default=False,
        ),
        
        migrations.RunPython(age_to_dob, migrations.RunPython.noop),

        migrations.AlterField(
            model_name='Subscriber',
            name='dob',
            field=models.DateField(),
            preserve_default=True,
        ),
    ]

</code></pre>
<p>well a little big rigt ?<br />
we have <code>migrations.AddField</code> anf <code>migrations.AlterField</code> it's just the trick to bypass not-null value from django migrate schema. cuz we need this always having data<br />
Otherwise, you will get the error <code>django.db.utils.IntegrityError: NOT NULL constraint failed:...</code></p>
<p>and run migrate this file.</p>
<h2 id="3-same-field-and-different-type"><a class="header" href="#3-same-field-and-different-type">3. SAME FIELD AND DIFFERENT TYPE.</a></h2>
<blockquote>
<p>This is the hard part on refactor operation a projects.<br />
Added new field and then copy data in to it will make many critical error on release and if we run in <code>container</code> we have to create lots of releases that's increment time and effort!</p>
</blockquote>
<p>As all we know. django model have <code>pk</code> default for your record, it is a <code>biginterger</code> and have <code>auto increment</code> on the back.<br />
Now if we expose this to the public like id of post or user id. This way is the door to invites crawler get my own data. Cuz it's predictable.<br />
So it must be unpredictable, by using uuid or other algorythm to create identify instead.<br />
I got my user model here</p>
<pre><code class="language-python">from django.contrib.auth.models import AbstractUser
from django.db import models


class User(AbstractUser):
	alias = models.CharField(max_length=255)
    ...	
</code></pre>
<p>That run quite long ago and got a lot of users\ 
At this if we call <code>.id</code> or <code>.pk</code> will return int for each record.<br />
And tons of code implemented before take time to refactor. Would you add more field like <code>uuid</code> and then go to fix, add, delete old logic ???<br />
NOOOOOOOOOOOOOOO! imma lazy guy. And i impl like this.</p>
<pre><code class="language-python">import uuid
from django.contrib.auth.models import AbstractUser
from django.db import models


class User(AbstractUser):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    alias = models.CharField(max_length=255)
    ...
</code></pre>
<p>Then make a function generate new id inside of migration stage.
make it.</p>
<pre><code class="language-python">user/migrations/0002_alter_user_id.py
# Generated by Django 4.1.7 on 2023-02-24 01:14

from django.db import migrations, models
import uuid


class Migration(migrations.Migration):

    dependencies = [
        (&quot;user&quot;, &quot;0001_initial&quot;),
    ]

    operations = [
        migrations.AlterField(
            model_name=&quot;user&quot;,
            name=&quot;id&quot;,
            field=models.UUIDField(
                default=uuid.uuid4, editable=False, primary_key=True, serialize=False
            ),
        ),
    ]
</code></pre>
<p>Django generated it for me. but it just applies to new record which insert in the future. what should I do for existed id.</p>
<p>So i apply my flow here and run it without any error.</p>
<pre><code class="language-python">from django.db import migrations, models
import uuid


def create_uuid(apps, schema_editor):
    User = apps.get_model('user', 'User')
    for user in list(User.objects.all()):
        user.id = uuid.UUID(int=user.id)
        user.save()


class Migration(migrations.Migration):

    dependencies = [
        (&quot;user&quot;, &quot;0001_initial&quot;),
    ]

    operations = [
        # add new one
        migrations.AddField(
            model_name='user',
            name='uuid',
            field=models.UUIDField(null=True),
        ),
        # seed new one
        migrations.RunPython(create_uuid, migrations.RunPython.noop),

        # change attributes
        migrations.AlterField(
            model_name='user',
            name='uuid',
            field=models.UUIDField(
                default=uuid.uuid4, editable=False, primary_key=True, serialize=False
            ),
        ),

        # remove old one
        migrations.RemoveField('User', 'id'),

        # rename to new
        migrations.RenameField(
            model_name='User',
            old_name='uuid',
            new_name='id'
        ),

        # Update attributes
        migrations.AlterField(
            model_name='user',
            name='id',
            field=models.UUIDField(
                primary_key=True, default=uuid.uuid4, serialize=False, editable=False
            ),
        ),
    ]
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../django/select_prefetch.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../celery.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../django/select_prefetch.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../celery.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script>
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>
        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
